import regeneratorRuntime from"./common/regenerator-runtime/runtime-module";import Chat from"./common/chat/chat";import store from"./store/index";import api from"./common/api/index";import util from"./common/utils/utils";let chat;const checkParams=(e,t)=>{for(let a=0,o=t.length;a<o;a++){const o=t[a];if(o.indexOf("|")>-1){const t=o.split("|");if(Object.keys(e).find(e=>e===t[0]||e===t[1]))return}if(void 0===e[o])throw new Error(`缺少参数${o}`)}};function initChat(e={}){const{userName:t,channelId:a,avatarUrl:o,channelDetail:r,userId:n}=store.get("main"),{param4:s,param5:i}=e,{userId:c}=store.get("app"),d={userId:n||c,userName:t,roomName:a,roomId:r.roomId,sessionId:r.sessionId,accountId:r.userId,pic:o,userType:r.isPPT?"slice":"student",chatToken:r.chatToken,param4:s,param5:i};return chatClose(),(chat=new Chat({...d,micUserId:c})).setup("sdk"),store.set({"main.chat":chat}),chat}function chatClose(){chat&&(chat.disconnectSocket(),chat=null)}const destroy=()=>{chatClose(),store.reset()},logVersion=()=>{console.log("VERSION: 2.1.1")};function setApp(e){if(logVersion(),"object"!=typeof e)throw Error("请传入正确格式参数");checkParams(e,["apiId","apiSecret|verifyUrl"]),store.set("app",e)}const _dealDetail=async e=>{const t="Y"===e.playbackEnabled&&e.hasPlayback;e.isPPT="ppt"===e.scene;try{if(t){const{data:t}=await api.getPlayBackVideos({channelId:e.channelId});if(200!==t.code)throw t;e.playbackList=t.data.contents}}catch(e){console.error(e)}return e},_getPolyvUserId=e=>new Promise((t,a)=>{const o=store.get("main.openId"),r=store.get("app.userId");e===o&&r?t({data:r}):api.getUserId(e).then(e=>{200!==e.data.code&&a(e),t(e.data)})}),_requestDetail=e=>api.getChannelDetail(e).then(e=>{if(200!==e.data.code)throw e;return e.data});function init(e){return new Promise((t,a)=>{util.isObj(e)||a(Error("options must be object!")),checkParams(e,["openId|userId","channelId","userName","avatarUrl"]),e&&e.pptDelayTime||(e.pptDelayTime=3e3),store.set("main",{...e}),store.set({"main.userInfo":{...e}});const{openId:o,channelId:r,immediateChat:n=!0,param4:s,param5:i}=e;Promise.all([_getPolyvUserId(o),_requestDetail(r)]).then(async a=>{const[o,r]=a,c=o.data,d=await _dealDetail(r.data);d.useVideo=e.useVideo||e.forceVideo||!1,d.globalInterval=e.globalInterval||!1,d.muted=e.muted||!1,store.set({"app.userId":c,"main.channelDetail":d}),n&&initChat({param4:s,param5:i}),t({detail:d,chat:chat})}).catch(e=>{"[object Object]"===Object.prototype.toString.call(e)&&a(e.data),a(e)})})}export default{setApp:setApp,init:init,destroy:destroy,initChat:initChat,api:api};