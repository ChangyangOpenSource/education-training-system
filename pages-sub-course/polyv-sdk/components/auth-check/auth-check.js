import api from"../../common/api/index";import store from"../../store/index";import Util from"../../common/utils/utils";Component({properties:{authType:{type:String,value:"",observer(t){const{authSettings:e}=this.data,a={code:e.codeAuthTips,phone:e.authTips,info:e.infoAuthTips}[t];this.setData({headText:a})}},authSettings:{type:Object,value:{}},channelId:{type:String,value:""},options:{type:Object,value:{}},infoFieldsModels:{type:Array,value:[],observer(t){const e=Array.from({length:t.length},()=>"");let a=!1;t.forEach((t,o)=>{"option"===t.type&&(e[o]=0),"mobile"===t.type&&(e[o]="mobile"),"Y"===t.sms&&(a=!0)}),this.setData({infoParams:e,needSms:a})}}},data:{headText:"",inputValue:"",optionIndex:0,infoImage:"",disable:!0,telephone:"",kaptcha:"",msg:"",infoParams:[],needSms:!1,imageId:"",smsBtnText:"点击获取",stopCount:!0,isCounting:!1},lifetimes:{attached(){store.get({"main.imageId":t=>{this.setData({imageId:t})}}),this.getInfoImage(),this.setData({stopCount:!1});const t=wx.getStorageSync("countValue");t>0&&this.smsCountDown(Date.now(),t,t=>{this.setData({smsBtnText:`${t}秒`,disable:!0,isCounting:!0})})},detached(){this.redirectTo=null}},methods:{hide(){this.triggerEvent("hideAuth",!1)},bindKeyInput(t){this.setData({inputValue:t.detail.value})},infoInput(t){let e=this.data.infoParams;const a=t.target.dataset.index,o=t.detail.value;e[a]=o,this.setData({infoParams:e})},getInfoImage(){const{channelId:t,imageId:e}=this.data;this.setData({infoImage:`https://live.polyv.cn/kaptcha?channelId=${t}&imageId=${e}&id=${Date.now()}`})},authCheck(){const{authType:t}=this.data;switch(t){case"code":this.codeCheck();break;case"phone":this.phoneCheck();break;case"info":this.infoCheck()}},bindPickerChange(t){const e=t.detail.value,a=t.target.dataset.index,o=this.data.infoParams;o[a]=e,this.setData({infoParams:o})},telInput(t){const{kaptcha:e,isCounting:a}=this.data;this.setData({telephone:t.detail.value,disable:!0}),5===e.length&&11===t.detail.value.length&&this.setData({disable:a})},kaptchaInput(t){const{telephone:e,isCounting:a}=this.data;this.setData({kaptcha:t.detail.value,disable:!0}),11===e.length&&5===t.detail.value.length&&this.setData({disable:a})},msgInput(t){this.setData({msg:t.detail.value})},getInfoMsg(){const{channelId:t,telephone:e,kaptcha:a,imageId:o,isCounting:s}=this.data;s||(Util.isPhoneNO(e)?5===a.length?api.getMsg(t,{mobile:e,kaptcha:a,imageId:o}).then(t=>{200!==t.data.code?(this.toastShow("验证码错误"),this.getInfoImage(),this.setData({kaptcha:""})):(this.setData({stopCount:!1}),this.smsCountDown(Date.now(),18e4,t=>{this.setData({smsBtnText:`${t}秒`,disable:!0,isCounting:!0})}))}):this.toastShow("请输入完整图片验证码"):this.toastShow("请输入正确的手机号"))},infoCheck(){const{channelId:t,telephone:e,msg:a}=this.data;let{infoParams:o}=this.data;const{userName:s,avatarUrl:n,openId:i}=this.data.options;this.checkInfoParams(o)&&(o=this.updateSelectParams(o),api.checkChannelInfo({channelId:t,propValue1:"mobile"===o[0]?"":o[0],propValue2:"mobile"===o[1]?"":o[1],propValue3:"mobile"===o[2]?"":o[2],propValue4:"mobile"===o[3]?"":o[3],propValue5:"mobile"===o[4]?"":o[4],propValue6:"mobile"===o[5]?"":o[5],propValue7:"mobile"===o[6]?"":o[6],propValue8:"mobile"===o[7]?"":o[7],propValue9:"mobile"===o[8]?"":o[8],propValue10:"mobile"===o[9]?"":o[9],mobile:e||"",smsCode:a||""}).then(e=>{if(200!==e.data.code)this.toastShow(e.data.message);else{this.setData({smsBtnText:"点击获取",stopCount:!0,isCounting:!1}),e&&e.header&&e.header["Set-Cookie"]&&wx.setStorageSync("cookieKey",e.header["Set-Cookie"]);let a=s;e.data.data.nickname&&(a=e.data.data.nickname,store.set({"main.userName":a})),wx.setStorageSync("plvAuthType","info"),this.enterToWatch({channelId:t,name:a,avatarUrl:n,openId:i})}}))},phoneCheck(){const{inputValue:t,channelId:e}=this.data,{avatarUrl:a,openId:o}=this.data.options;""!==t?api.checkChannelPhone({channelId:e,phone:t,origin:"applet"}).then(t=>{if(200===t.data.code){t&&t.header&&t.header["Set-Cookie"]&&wx.setStorageSync("cookieKey",t.header["Set-Cookie"]);const{nickname:s,viewerId:n}=t.data.data;store.set({"main.userName":s}),wx.setStorageSync("plvAuthType","phone"),this.enterToWatch({channelId:e,name:s,avatarUrl:a,openId:o,viewerId:n})}else this.toastShow("会员码错误")}):this.toastShow("会员码不能为空")},codeCheck(){const{inputValue:t,channelId:e}=this.data,{userName:a,avatarUrl:o,openId:s}=this.data.options;""!==t?api.checkChannelCode({channelId:e,code:t}).then(t=>{if(200===t.data.code){t&&t.header&&t.header["Set-Cookie"]&&wx.setStorageSync("cookieKey",t.header["Set-Cookie"]);let n=a;t.data.data.nickname&&(n=t.data.data.nickname,store.set({"main.userName":n})),wx.setStorageSync("plvAuthType","code"),this.enterToWatch({channelId:e,name:n,avatarUrl:o,openId:s})}else this.toastShow("验证码错误")}):this.toastShow("验证码不能为空")},checkInfoParams(t){let e=!0;return t.forEach(t=>{if(0===t||t||(e=!1,this.toastShow("请填写所有信息后提交")),"mobile"===t){const{telephone:t,msg:a,needSms:o}=this.data;t||(this.toastShow("请填写手机号"),e=!1),!a&&o&&(this.toastShow("短信验证码错误"),e=!1)}}),e},updateSelectParams(t){let e=t;return this.data.infoFieldsModels.forEach((t,a)=>{"option"===t.type&&(e[a]=t.options[e[a]])}),e},smsCountDown(t,e,a){if(!a||!t||!e)return;const{stopCount:o}=this.data,s=Math.max(0,e-(Date.now()-t));if(s>0&&!o&&setTimeout(()=>this.smsCountDown(t,e,a),1e3),s>0&&(wx.setStorageSync("countValue",s),a(Math.round(s/1e3))),0===s){wx.setStorageSync("countValue","");const{kaptcha:t,telephone:e}=this.data;this.setData({smsBtnText:"再次发送",isCounting:!1}),5===t.length&&11===e.length&&this.setData({disable:!1})}},enterToWatch(...t){"function"!=typeof this.redirectTo&&(this.redirectTo=Util.throttle(t=>{const{channelId:e,name:a,avatarUrl:o,openId:s,viewerId:n}=t,i=n?`&viewerId=${n}`:"";wx.redirectTo({url:`/pages/watch/watch?channelId=${e}&userName=${a}&avatarUrl=${o}&openId=${s}${i}`})})),this.redirectTo(...t)},previewImage(){const{qcodeImg:t}=this.data.authSettings;wx.previewImage({current:`https:${t}`,urls:[`https:${t}`]})},toastShow(t,e=2e3){wx.showToast({title:t,icon:"none",duration:e})}}});